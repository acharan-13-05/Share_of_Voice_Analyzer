<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Fan - Share of Voice Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      color: #222;
      background: #f5f4fa;
    }
    h2 {
      color: #4b0082;
      text-align: center;
      font-size: 2em;
      margin-bottom: 8px;
    }
    .small {
      font-size: 0.9em;
      color: #555;
      text-align: center;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      justify-content: center;
    }
    label {
      font-weight: bold;
      color: #4b0082;
    }
    input, button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background: #4b0082;
      color: white;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #36005a;
    }
    .card {
      border: 1px solid #eee;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      background: white;
    }
    .row {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 300px;
    }
    #status {
      margin-top: 8px;
      color: #4b0082;
      font-weight: bold;
      text-align: center;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #4b0082;
      color: white;
    }
    .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 280px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h2>Smart Fan - Share of Voice Analyzer</h2>
  <p class="small">Default brands: {{ brands|join(", ") }} — change `.env` BRANDS to modify.</p>

  <div class="controls">
    <label>Search query:
      <input id="query" value="smart fan" />
    </label>
    <label>Per platform (N):
      <input id="per_platform" value="{{ per_platform }}" type="number" style="width:70px" />
    </label>
    <button id="run">Run analysis</button>
  </div>

  <div id="status">Idle.</div>

  <div class="row">
    <div class="col card">
      <h4>SoV (composite)</h4>
      <div style="height:320px">
        <canvas id="sovChart" style="max-height:320px"></canvas>
      </div>
    </div>

    <div class="col card">
      <h4>Share of Positive Voice (SoPV)</h4>
      <div style="height:320px">
        <canvas id="spvChart" style="max-height:320px"></canvas>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="col card">
      <h4>Results table</h4>
      <div id="tableArea" class="small">No data yet.</div>
    </div>
  </div>

<script>
let sovChart = null;
let spvChart = null;
const defaultColors = ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"];

function drawPie(elId, labels, data, chartRef, titleText) {
  const ctx = document.getElementById(elId).getContext('2d');
  if (chartRef) chartRef.destroy();

  if (!labels || labels.length === 0 || data.reduce((a,b)=>a+b,0) === 0) {
    labels = ["No Data"];
    data = [1];
  }

  const bg = labels.map((_,i) => defaultColors[i % defaultColors.length]);

  return new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels.map((l,i) => `${l}`),
      datasets: [{ data: data, backgroundColor: bg }]
    },
    options: {
      plugins: {
        title: { display: true, text: titleText },
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: function(context) {
              let v = context.parsed;
              let total = context.dataset.data.reduce((a,b)=>a+b,0);
              let pct = ((v/total)*100).toFixed(1);
              return `${context.label}: ${v} (${pct}%)`;
            }
          }
        }
      },
      maintainAspectRatio: false
    }
  });
}

async function runAnalysis() {
  const q = document.getElementById("query").value;
  const n = parseInt(document.getElementById("per_platform").value || 10);
  document.getElementById("status").innerText = "Running analysis... please wait.";
  document.getElementById("run").disabled = true;

  try {
    const res = await fetch("/analyze", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({query: q, per_platform: n})
    });
    const j = await res.json();
    document.getElementById("status").innerText = "Done.";

    const summary = j.summary || [];
    let labels = summary.map(x => x.brand);
    let sovVals = summary.map(x => x.SoV_score);
    if (sovVals.reduce((a,b)=>a+b,0) === 0) {
      sovVals = summary.map(x => x.mentions);
    }
    let spvVals = summary.map(x => x.SoPV);

    const scale = 100;
    sovVals = sovVals.map(v => Math.round(v*scale));
    spvVals = spvVals.map(v => Math.round(v*100));

    sovChart = drawPie("sovChart", labels, sovVals, sovChart, "Share of Voice (composite)");
    spvChart = drawPie("spvChart", labels, spvVals, spvChart, "Share of Positive Voice (SoPV)");

    if (summary.length === 0) {
      document.getElementById("tableArea").innerHTML = "<div class='small'>No results — please check API keys or try a different query.</div>";
    } else {
      let html = "<table><tr><th>Brand</th><th>Mentions</th><th>Engagement</th><th>Positive Mentions</th><th>Positive Rate</th><th>SoV Score</th></tr>";
      for (const r of summary) {
        html += `<tr><td>${r.brand}</td><td>${r.mentions}</td><td>${r.engagement}</td><td>${r.positive_mentions}</td><td>${r.positive_rate}</td><td>${r.SoV_score}</td></tr>`;
      }
      html += "</table>";
      document.getElementById("tableArea").innerHTML = html;
    }
  } catch (e) {
    console.error(e);
    document.getElementById("status").innerText = "Error running analysis: " + e.message;
  } finally {
    document.getElementById("run").disabled = false;
  }
}

document.getElementById("run").addEventListener("click", () => runAnalysis());
</script>
</body>
</html>
